<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tenant Details</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/global.css">
  <style>
    .scrollable-history {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  
  <div class="container">
    <!-- Tenant Details Section -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Unit Number: <%= tenant.unitNumber %></h5>
        <p class="card-text">
          <strong>Meter IDs:</strong> <%= tenant.meterIds.join(", ") %><br>
          <strong>Account Number:</strong> <%= tenant.accountNumber %><br>
          <strong>Contact Name:</strong> <%= tenant.contactName %><br>
          <strong>Email:</strong> <%= tenant.email %>
        </p>
        <a href="/tenants/<%= tenant._id %>/edit" class="btn btn-primary">Edit Tenant</a>
      </div>
    </div>

    <!-- Filter & Calculation Section -->
    <div class="mb-4">
      <h4>Filter Meter History & Calculate Totals</h4>
      <form id="filterForm" class="row gy-2 gx-3 align-items-center">
        <div class="col-auto">
          <label class="visually-hidden" for="startDate">Start Date</label>
          <input type="date" class="form-control" id="startDate" placeholder="Start Date">
        </div>
        <div class="col-auto">
          <label class="visually-hidden" for="endDate">End Date</label>
          <input type="date" class="form-control" id="endDate" placeholder="End Date">
        </div>
        <div class="col-auto">
          <label class="visually-hidden" for="globalCost">Cost per kWh</label>
          <input type="number" class="form-control" id="globalCost" step="0.01" placeholder="Cost per kWh" value="0.21">
        </div>
        <div class="col-auto">
          <button type="button" id="calcBtn" class="btn btn-primary">Calculate Total</button>
        </div>
      </form>
      <div id="calcResults" class="mt-2"></div>
    </div>

    <!-- Scrollable Meter History Table (Current Month Only) -->
    <h3>Meter History (Current Month - kWHNet)</h3>
    <% 
      const currentMonth = new Date().toISOString().substring(0, 7);
      let currentReadings = meterReadings.filter(r => r.date.substring(0, 7) === currentMonth);
    %>
    <% if (currentReadings && currentReadings.length > 0) { %>
      <div class="scrollable-history">
        <table class="table table-striped" id="historyTable">
          <thead>
            <tr>
              <th>Meter</th>
              <th>Date</th>
              <th>Time</th>
              <th>kWHNet</th>
            </tr>
          </thead>
          <tbody>
            <% currentReadings.forEach(reading => { %>
              <tr data-date="<%= reading.date %>">
                <td><%= reading.meter %></td>
                <td><%= reading.date %></td>
                <td><%= reading.time %></td>
                <td>
                  <% if (reading.kWHNet !== undefined && reading.kWHNet !== null && reading.kWHNet !== "") { %>
                    <%= parseFloat(reading.kWHNet).toFixed(3) %>
                  <% } else { %>
                    N/A
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p>No meter history found for the current month.</p>
    <% } %>

    <!-- Bar Graph for Monthly Totals -->
    <h3 class="mt-5">Monthly Totals (kWHNet)</h3>
    <canvas id="myChart" width="400" height="200"></canvas>

    <!-- Email Invoice Section with Live Preview -->
    <h4 class="mt-5">Email Invoice</h4>
    <form action="/tenants/<%= tenant._id %>/invoice" method="POST" class="mb-4" id="invoiceForm">
      <div class="mb-3">
        <label for="invoiceStartDate" class="form-label">Start Date</label>
        <input type="date" class="form-control" name="startDate" id="invoiceStartDate" required>
      </div>
      <div class="mb-3">
        <label for="invoiceEndDate" class="form-label">End Date</label>
        <input type="date" class="form-control" name="endDate" id="invoiceEndDate" required>
      </div>
      <div class="mb-3">
        <label for="invoiceCost" class="form-label">Cost per kWh</label>
        <input type="number" class="form-control" name="costPerKwh" id="invoiceCost" step="0.01" required value="0.21">
      </div>
      <button type="button" id="previewInvoiceBtn" class="btn btn-secondary">Preview Invoice</button>
      <button type="submit" class="btn btn-success">Email Invoice</button>
      <div id="invoicePreview" class="mt-3"></div>
    </form>

    <a href="/tenants" class="btn btn-secondary mb-5">Back to Tenants</a>
  </div>

  <script>
    var meterReadings = <%- JSON.stringify(meterReadings) %>;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    // (Existing JS calculation code remains unchanged)
  </script>
</body>
</html>
